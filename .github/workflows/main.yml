name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    # STAGE 1: Test
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    - name: Run Tests
      run: |
        pip install flask redis pytest
        cd backend
        pytest

    # STAGE 2: Login Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # STAGE 3: Build & Push
    - name: Build and Push Frontend
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/poros-frontend:latest
    
    - name: Build and Push Backend
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/poros-backend:latest

  deploy:
    needs: build-test-push
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Install SSHPass
      run: sudo apt-get install -y sshpass

    - name: Deploy to VPS via SSHPass
      env:
        SSHPASS: ${{ secrets.VPS_PASSWORD }}
      run: |
        # 1. Buat Command SSH
        SSH_CMD="sshpass -e ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@${{ secrets.HOST }}"

        # 2. Test Koneksi & BUAT FOLDER DULU (Penting!)
        echo "Testing connection & Creating folder..."
        $SSH_CMD "mkdir -p ~/app && echo '‚úÖ Folder ~/app berhasil dibuat!'"

        # 3. Copy file docker-compose.yml ke server (Sekarang pasti bisa)
        echo "Uploading docker-compose..."
        sshpass -e scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null docker-compose.yml root@${{ secrets.HOST }}:~/app/docker-compose.yml

        # 4. Eksekusi Deploy
        echo "Executing remote deployment..."
        $SSH_CMD "
          # Install Docker jika belum ada
          if ! command -v docker &> /dev/null; then
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
          fi

          cd ~/app

          # Login Docker
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

          # Set Environment Variable
          export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}

          # Restart Container
          echo '‚¨áÔ∏è Pulling images...'
          docker compose pull
          
          echo 'üöÄ Restarting services...'
          docker compose down || true
          docker compose up -d
          
          echo '‚úÖ Deployment Finished! Website is Live!'
        "